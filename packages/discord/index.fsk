import "std/http.fsk";
import "std/fs.fsk";

class DiscordClient {
    fn init(token) {
        this.token = token;
        this.gatewayUrl = "wss://gateway.discord.gg/?v=10&encoding=json";
        this.wsId = -1;
        this.heartbeatInterval = 0;
        this.lastSequence = nil;
        
        this.handlers = [];
    }
    
    fn on(event, callback) {
        this.handlers.push({"event": event, "callback": callback});
    }
    
    fn login() {
        print "Connecting to Discord Gateway...";
        this.wsId = WS.connect(this.gatewayUrl);
        if (this.wsId == -1) {
            print "Failed to connect to Gateway.";
            return false;
        }
        
        print "Connected. WS ID: " + this.wsId;
        
        while (true) {
             let msgs = WS.poll(this.wsId);
             for (let i = 0; i < msgs.length; i = i + 1) {
                 this.handleMessage(msgs[i]);
             }
             if (msgs.length == 0) {
             }
        }
    }
    
    fn handleMessage(raw) {
        let payload = JSON.parse(raw);
        if (payload == nil) return;
        
        let op = payload.op;
        let t = payload.t;
        let d = payload.d;
        
        if (payload.s != nil) this.lastSequence = payload.s;
        
        if (op == 10) {
            this.heartbeatInterval = d.heartbeat_interval;
            print "Hello received. Heartbeat interval: " + this.heartbeatInterval;
            
            let identify = {
                "op": 2,
                "d": {
                    "token": this.token,
                    "intents": 513, 
                    "properties": {
                        "os": "linux",
                        "browser": "fsk",
                        "device": "fsk"
                    }
                }
            };
            WS.send(this.wsId, JSON.stringify(identify));
            
        } else if (op == 0) { 
            print "Event: " + t;
            for (let i = 0; i < this.handlers.length; i = i + 1) {
                if (this.handlers[i].event == t) {
                    this.handlers[i].callback(d);
                }
            }
        }
    }
    
    fn sendMessage(channelId, content) {
        print "Sending message to " + channelId + ": " + content;
    }
}
